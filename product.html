<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sản phẩm</title>
  <style>
    :root{--b:#1a73e8;--b2:#0b57d0;--line:#e0e0e0;--muted:#5f6368;--soft:#f6f9ff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:linear-gradient(180deg,var(--soft),#fff 45%);color:#202124}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .top{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--b),#4fc3f7)}
    nav a{color:var(--b2);font-weight:800;text-decoration:none;margin-right:10px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.04);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;display:flex;justify-content:space-between;align-items:center}
    .content{padding:14px 16px}
    .row{display:grid;grid-template-columns:1.2fr .8fr .4fr;gap:10px}
    @media(max-width:860px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:12px;outline:none;font-size:14px}
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 4px rgba(26,115,232,.12)}
    button{border:none;border-radius:12px;padding:11px 14px;cursor:pointer;font-weight:900;background:linear-gradient(135deg,var(--b),var(--b2));color:#fff}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{color:var(--muted);font-weight:900;background:#fbfbfd;text-align:left}
    .tiny{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .img{width:46px;height:46px;border-radius:12px;border:1px solid var(--line);overflow:hidden;background:#fff}
    .img img{width:100%;height:100%;object-fit:cover}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-weight:900">Sản phẩm</div>
          <div class="tiny">Tìm kiếm theo OEM/SKU, tên, mã thay thế...</div>
          <nav style="margin-top:6px">
            <a href="./index.html">Nhập hàng</a>
            <a href="./product.html">Sản phẩm</a>
            <a href="./admin.html">Admin</a>
          </nav>
        </div>
      </div>
      <div class="tiny" id="count">0</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2><span>Danh sách</span><span class="tiny">Ảnh lấy từ link Drive đã lưu</span></h2>
    <div class="content">
      <div class="row">
        <div>
          <label>Tìm kiếm</label>
          <input id="search" placeholder="VD: OEM, SKU, tên, mã thay thế..." />
        </div>
        <div>
          <label>Nhóm hàng</label>
          <select id="category"></select>
        </div>
        <div style="display:flex;align-items:end">
          <button id="btn">Tải</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Ảnh</th>
              <th>Mã</th>
              <th>Tên</th>
              <th>Nhóm</th>
              <th>Tồn</th>
              <th>Giá</th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="6" class="tiny">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<script type="module">
  import { jsonp } from "./app.js";
  const $ = (id)=>document.getElementById(id);

  async function init(){
    const init = await jsonp('init');
    $('category').innerHTML = `<option value="">Tất cả</option>` + (init.categories||[])
      .map(c=>`<option value="${c}">${c}</option>`).join('');
    load();
  }

  function firstImage(urls){
    const list = String(urls||'').split(',').map(x=>x.trim()).filter(Boolean);
    return list[0] || '';
  }

  async function load(){
    const search = $('search').value || '';
    const category = $('category').value || '';
    const res = await jsonp('products', { search, category, limit: 500 });
    const rows = (res && res.rows) ? res.rows : [];
    $('count').textContent = rows.length + ' sản phẩm';

    const tb = $('tb');
    tb.innerHTML = '';
    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="6" class="tiny">Chưa có dữ liệu</td></tr>`;
      return;
    }
    rows.forEach(p=>{
      const img = firstImage(p.image_urls);
      const code = `${p.code_type}:${p.code_main}`;
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>
            <div class="img">${img ? `<a href="${img}" target="_blank"><img src="${img}"></a>` : ''}</div>
          </td>
          <td class="mono">${code}<div class="tiny">${p.code_alt||''}</div></td>
          <td>${p.name||''}<div class="tiny">${p.brand_model||''}</div></td>
          <td>${p.category||''}<div class="tiny">${p.shelf||''}</div></td>
          <td>${p.stock||''}</td>
          <td class="tiny">Nhập: ${p.cost_price||''}<br/>Bán: ${p.sale_price||''}</td>
        </tr>
      `);
    });
  }

  $('btn').addEventListener('click', (e)=>{ e.preventDefault(); load(); });
  $('search').addEventListener('keydown', (e)=>{ if (e.key==='Enter') load(); });

  init();
</script>
</body>
</html>
