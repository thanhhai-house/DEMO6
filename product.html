<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <base href="./">
  <title>Products</title>
  <style>
    :root{
      --b:#1a73e8;--b2:#0b57d0;
      --line:#e0e0e0;--muted:#5f6368;
      --soft:#eaf2ff;
      --card:#ffffff;
      --shadow:0 14px 40px rgba(26,115,232,.12);
      --shadow2:0 10px 24px rgba(0,0,0,.06);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui;color:#202124;
      background:linear-gradient(180deg,var(--soft),#fff 55%);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}

    /* ===== HEADER / NAV (FIX 404) ===== */
    header{
      display:flex;align-items:center;gap:12px;
      padding:10px 0;
    }
    .logo{
      width:44px;height:44px;border-radius:12px;
      background:#fff;border:1px solid #dbe7ff;display:grid;place-items:center
    }
    .t1{font-weight:900}
    .t2{font-size:12px;color:var(--muted)}
    nav{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--b2);font-weight:900;text-decoration:none}
    nav a:hover{text-decoration:underline}

    .card{
      background:var(--card);
      border:1px solid #dbe7ff;
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden
    }
    .card h2{
      margin:0;padding:14px 16px;border-bottom:1px solid #e8f0fe;
      font-size:16px;display:flex;justify-content:space-between;align-items:center
    }
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;
      background:#e8f0fe;color:var(--b2);border:1px solid #d2e3fc;font-weight:900
    }

    .content{padding:14px 16px}
    .row{display:grid;grid-template-columns:1.2fr .8fr .35fr;gap:10px}
    @media(max-width:860px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select{
      width:100%;padding:11px 12px;border:1px solid #dbe7ff;border-radius:14px;
      outline:none;font-size:14px;background:#fff
    }
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 4px rgba(26,115,232,.12)}
    button{
      border:none;border-radius:14px;padding:11px 14px;cursor:pointer;font-weight:900;
      background:linear-gradient(135deg,var(--b),var(--b2));color:#fff
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
    @media(max-width:720px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(max-width:420px){ .grid{grid-template-columns:1fr;} }

    .p{
      border:1px solid #dbe7ff;
      border-radius:24px;
      background:#fff;
      box-shadow:var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 320px;
    }
    .p__top{
      position:relative;
      background:linear-gradient(180deg,#f2f7ff,#ffffff 85%);
      padding:10px 10px 0;
    }
    .badge{
      position:absolute;left:10px;top:10px;
      background:#e8f0fe;border:1px solid #d2e3fc;color:#0b57d0;
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
    }
    .badge--sale{
      left:auto;right:10px;
      background:#fff0f0;border:1px solid #ffd2d2;color:#b42318;
    }
    .p__imgWrap{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:18px;
      background:#fff;
      border:1px solid #e8f0fe;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .p__imgWrap img{width:100%;height:100%;object-fit:contain}
    .p__body{padding:12px 12px 10px;display:flex;flex-direction:column;gap:8px}
    .p__name{
      font-weight:900;
      line-height:1.25;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;
      min-height: 2.5em;
    }
    .p__meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      background:#f5f8ff;border:1px solid #e8f0fe;color:#315a9b;
      padding:4px 8px;border-radius:999px;font-weight:800
    }
    .p__priceRow{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
    .price{
      font-weight:1000;
      font-size:18px;
      color:#0b57d0;
    }
    .subprice{font-size:12px;color:var(--muted)}
    .p__bottom{
      margin-top:auto;
      padding:10px 12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-top:1px solid #eef4ff;
      background:linear-gradient(180deg,#fff,#fbfdff);
    }
    .stock{
      font-size:12px;color:#0f5132;background:#ecfdf3;border:1px solid #abefc6;
      padding:6px 10px;border-radius:999px;font-weight:900;
    }
    .code{
      font-size:12px;color:#111827;background:#f3f4f6;border:1px solid #e5e7eb;
      padding:6px 10px;border-radius:999px;font-weight:900;
      max-width: 55%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }

    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">

  <!-- HEADER + NAV FIX 404 -->
  <header>
    <div class="logo">üöö</div>
    <div>
      <div class="t1">Thanh h·∫£i - ph·ª• t√πng</div>
      <div class="t2">GitHub UI ¬∑ Apps Script l∆∞u Sheet + Drive</div>
    </div>
    <nav>
      <a href="./index.html">Index</a>
      <a href="./products.html">Products</a>
      <a href="./admin.html">Admin</a>
    </nav>
  </header>

  <div class="card">
    <h2><span>Danh s√°ch s·∫£n ph·∫©m</span><span class="pill" id="count">0</span></h2>
    <div class="content">
      <div class="row">
        <div>
          <label>T√¨m ki·∫øm</label>
          <input id="search" placeholder="OEM/SKU, t√™n, m√£ thay th·∫ø...">
        </div>
        <div>
          <label>Nh√≥m h√†ng</label>
          <select id="category">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div style="display:flex;align-items:end">
          <button id="btn">T·∫£i</button>
        </div>
      </div>

      <div id="grid" class="grid">
        <div class="tiny">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
      </div>

      <div class="tiny" id="dbg" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<script>
  /************ C·∫§U H√åNH ************/
  const API_BASE = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE"; 
  // v√≠ d·ª•: https://script.google.com/macros/s/AKfycbxxxx/exec
  const USE_MOCK_WHEN_NO_API = true;

  /************ HELPERS ************/
  const $ = (id)=>document.getElementById(id);

  const money = (v)=>{
    const n = Number(v);
    if (!isFinite(n)) return '';
    return new Intl.NumberFormat('vi-VN').format(n) + 'ƒë';
  };

  function normKeyObj(o){
    const x = {};
    if (!o || typeof o !== "object") return x;
    for (const [k,v] of Object.entries(o)){
      x[String(k).trim().toLowerCase()] = v;
    }
    return x;
  }

  function pick(obj, ...keys){
    for (const k of keys){
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') return v;
    }
    return '';
  }

  function firstImage(v){
    if (Array.isArray(v)) return v[0] || '';
    if (typeof v === 'string') return v.split(/[,\s]+/).filter(Boolean)[0] || '';
    return '';
  }

  async function api(action, params={}){
    if (!API_BASE || API_BASE.includes("PASTE_YOUR")){
      if (USE_MOCK_WHEN_NO_API) return mockApi(action, params);
      throw new Error("Ch∆∞a c·∫•u h√¨nh API_BASE");
    }

    const url = new URL(API_BASE);
    url.searchParams.set("action", action);
    for (const [k,v] of Object.entries(params)){
      url.searchParams.set(k, v);
    }

    const r = await fetch(url.toString(), { method:"GET" });
    if (!r.ok) throw new Error("API l·ªói: " + r.status);
    return await r.json();
  }

  function mockApi(action, params){
    if (action === "init"){
      return Promise.resolve({ categories:["ƒê·ªông c∆°","G·∫ßm","ƒêi·ªán"] });
    }
    if (action === "products"){
      const rows = [
        {
          "Tags Products":"L·ªçc d·∫ßu Toyota",
          "category":"ƒê·ªông c∆°",
          "sale_price":120000,
          "cost_price":80000,
          "stock":15,
          "code_type":"SKU",
          "code_main":"TOY-OF-01",
          "image_urls":"https://i.imgur.com/6XH9K0N.png"
        },
        {
          "Tags Products":"Bugi Denso",
          "category":"ƒêi·ªán",
          "sale_price":95000,
          "cost_price":60000,
          "stock":32,
          "code_type":"SKU",
          "code_main":"DNS-BG-02",
          "image_urls":"https://i.imgur.com/2yaf2wb.png"
        }
      ];

      const q = (params.search || "").toLowerCase().trim();
      const cat = (params.category || "").toLowerCase().trim();

      const filtered = rows.filter(r=>{
        const p = normKeyObj(r);
        const name = pick(p,"tags products","products","name");
        const code = pick(p,"code_main","sku","code","oem");
        const c = pick(p,"category");
        const okQ = !q || (String(name).toLowerCase().includes(q) || String(code).toLowerCase().includes(q));
        const okC = !cat || String(c).toLowerCase() === cat;
        return okQ && okC;
      });

      return Promise.resolve({ rows: filtered });
    }
    return Promise.resolve({});
  }

  /************ RENDER ************/
  function render(rows){
    const grid = $('grid');
    grid.innerHTML = '';

    if (!Array.isArray(rows) || rows.length === 0){
      grid.innerHTML = `<div class="tiny">Ch∆∞a c√≥ d·ªØ li·ªáu</div>`;
      return;
    }

    rows.forEach(raw=>{
      const p = normKeyObj(raw);

      const name = pick(p, "tags products", "products", "name", "t√™n", "ten") || "‚Äî";
      const category = pick(p, "category", "nh√≥m h√†ng", "group");
      const brand_model = pick(p, "brand_model", "brand model", "model", "h√£ng xe", "hang xe");
      const shelf = pick(p, "shelf", "k·ªá", "ke");
      const code_alt = pick(p, "code_alt", "m√£ thay th·∫ø", "ma thay the", "alt");

      const code_type = pick(p, "code_type", "lo·∫°i m√£", "loai ma");
      const code_main = pick(p, "code_main", "sku", "oem", "code", "m√£ ch√≠nh", "ma chinh");
      const codeMain = `${code_type||''}:${code_main||''}`.replace(/^:|:$/g,'');

      const sale_price = pick(p, "sale_price", "sale price", "gi√° b√°n", "gia ban", "price");
      const cost_price = pick(p, "cost_price", "cost price", "gi√° nh·∫≠p", "gia nhap", "cost");
      const stockVal  = pick(p, "stock", "t·ªìn", "ton", "qty", "quantity");

      const discount = pick(p, "discount_percent", "gi·∫£m %", "giam %", "discount");

      let image_urls = p["image_urls"] ?? p["images"] ?? p["image"] ?? "";
      const img = firstImage(image_urls);

      const sale = money(sale_price);
      const cost = money(cost_price);
      const stock = (stockVal ?? '') === '' ? '' : String(stockVal);

      grid.insertAdjacentHTML('beforeend', `
        <div class="p">
          <div class="p__top">
            ${category ? `<div class="badge">${category}</div>` : ``}
            ${discount ? `<div class="badge badge--sale">-${discount}%</div>` : ``}

            <div class="p__imgWrap">
              ${img ? `<a href="${img}" target="_blank" rel="noopener"><img src="${img}" alt=""></a>` : `<div class="tiny">No image</div>`}
            </div>
          </div>

          <div class="p__body">
            <div class="p__name">${name}</div>

            <div class="p__meta">
              ${brand_model ? `<span class="tag">${brand_model}</span>` : ``}
              ${shelf ? `<span class="tag">K·ªá: ${shelf}</span>` : ``}
              ${code_alt ? `<span class="tag">${code_alt}</span>` : ``}
            </div>

            <div class="p__priceRow">
              <div class="price">${sale || '‚Äî'}</div>
              <div class="subprice">${cost ? `Nh·∫≠p: ${cost}` : ''}</div>
            </div>
          </div>

          <div class="p__bottom">
            <div class="stock">${stock ? `T·ªìn: ${stock}` : 'T·ªìn: ‚Äî'}</div>
            <div class="code" title="${codeMain}">${codeMain || 'NO-CODE'}</div>
          </div>
        </div>
      `);
    });
  }

  async function init(){
    try{
      const init = await api('init');
      const cats = init.categories || [];
      $('category').innerHTML =
        `<option value="">T·∫•t c·∫£</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
      $('dbg').textContent = (API_BASE && !API_BASE.includes("PASTE_YOUR")) ? "API: OK" : "API: ƒëang d√πng MOCK (ch∆∞a c·∫•u h√¨nh API_BASE)";
      await load();
    }catch(err){
      $('dbg').textContent = "L·ªói init: " + err.message;
      console.error(err);
    }
  }

  async function load(){
    try{
      const search = $('search').value || '';
      const category = $('category').value || '';
      const res = await api('products', { search, category, limit: 800 });

      const rows = res?.rows || [];
      $('count').textContent = rows.length + ' SP';
      render(rows);
    }catch(err){
      $('grid').innerHTML = `<div class="tiny">L·ªói load: ${err.message}</div>`;
      console.error(err);
    }
  }

  $('btn').onclick=(e)=>{e.preventDefault();load();};
  $('search').addEventListener('keydown',(e)=>{ if(e.key==='Enter') load(); });
  $('category').addEventListener('change', load);

  init();
</script>
</body>
</html>
